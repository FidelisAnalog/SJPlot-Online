<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SJPlot Online</title>
    <link rel="stylesheet" href="https://pyscript.net/releases/2024.8.2/core.css">
    <script type="module" src="https://pyscript.net/releases/2024.8.2/core.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
        }
        h1 { color: #333; margin-bottom: 10px; font-size: 2.5em; }
        .subtitle { color: #666; margin-bottom: 30px; font-size: 1.1em; }
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            margin-bottom: 30px;
        }
        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px;
        }
        .config-section {
            background: #f8f9ff;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        .config-item { display: flex; flex-direction: column; }
        .config-item label {
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        .config-item select, .config-item input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }
        .checkbox-item { display: flex; align-items: center; gap: 10px; }
        .checkbox-item input[type="checkbox"] { width: 20px; height: 20px; }
        .analyze-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px 50px;
            border: none;
            border-radius: 50px;
            font-size: 1.2em;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
        }
        .analyze-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 500;
            display: none;
        }
        #status.info { background: #e3f2fd; color: #1976d2; display: block; }
        #status.processing { background: #fff3e0; color: #f57c00; display: block; }
        #status.success { background: #e8f5e9; color: #388e3c; display: block; }
        #status.error { background: #ffebee; color: #c62828; display: block; }
        .file-info {
            background: #fff3e0;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-left: 4px solid #ff9800;
        }
        .loading { display: none; text-align: center; padding: 20px; }
        .loading.active { display: block; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #output { margin-top: 30px; }
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 2px solid #eee;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ SJPlot Online</h1>
        <p class="subtitle">Full Phono Cartridge Frequency Response Analysis</p>
        
        <div class="upload-area">
            <h3>üìÅ Upload Audio File(s)</h3>
            <input type="file" id="fileInput0" style="display:none" accept=".wav" />
            <input type="file" id="fileInput1" style="display:none" accept=".wav" />
            <button class="upload-btn" onclick="document.getElementById('fileInput0').click()">
                File 0 (Left/Primary)
            </button>
            <button class="upload-btn" onclick="document.getElementById('fileInput1').click()">
                File 1 (Right) - Optional
            </button>
            <div id="fileInfo" class="file-info" style="display: none;"></div>
        </div>
        
        <div class="config-section">
            <h3 style="margin-bottom: 20px;">‚öôÔ∏è Configuration</h3>
            <div class="config-grid">
                <div class="config-item">
                    <label>Plot Style</label>
                    <select id="plotStyle">
                        <option value="1">Style 1</option>
                        <option value="4" selected>Style 4 (Dual + Zoom)</option>
                        <option value="5">Style 5</option>
                    </select>
                </div>
                <div class="config-item">
                    <label>RIAA Mode</label>
                    <select id="riaaMode">
                        <option value="0">None</option>
                        <option value="1">Bass Only</option>
                        <option value="2" selected>Treble Only</option>
                        <option value="3">Both</option>
                    </select>
                </div>
                <div class="config-item">
                    <label>Normalize (Hz)</label>
                    <input type="number" id="normalize" value="1000" />
                </div>
                <div class="config-item checkbox-item">
                    <input type="checkbox" id="riaaInverse" checked />
                    <label>Inverse RIAA</label>
                </div>
            </div>
        </div>
        
        <button class="analyze-btn" id="analyzeBtn" onclick="startAnalysis()" disabled>
            ‚è≥ Loading PyScript...
        </button>
        
        <div id="pyscriptStatus" style="text-align: center; margin-top: 10px; color: #666; font-size: 0.9em;">
            Initializing Python environment...
        </div>
        
        <div id="status"></div>
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p><strong>Processing Full SJPlot Analysis...</strong></p>
        </div>
        <div id="output"></div>
        
        <div class="footer">
            <p>Full <a href="https://github.com/FidelisAnalog/SJPlot">SJPlot</a> by Scott Wurcer</p>
        </div>
    </div>

    <py-config>
        packages = ["numpy", "scipy", "matplotlib"]
    </py-config>

    <py-script>
from scipy.signal import sosfiltfilt, iirfilter, lfilter
from scipy.io import wavfile
import matplotlib.pyplot as plt
from matplotlib.gridspec import GridSpec
from matplotlib.offsetbox import AnchoredText
import numpy as np
import io
import base64
from js import document, console

# Global storage
file_data = {'file0': None, 'file1': None, 'config': None}

def ft_window(n):
    a0, a1, a2, a3, a4 = 0.21557895, 0.41663158, 0.277263158, 0.083578947, 0.006947368
    x = np.arange(n)
    w = (a0 - a1*np.cos(2*np.pi*x/(n-1)) + a2*np.cos(4*np.pi*x/(n-1)) - 
         a3*np.cos(6*np.pi*x/(n-1)) + a4*np.cos(8*np.pi*x/(n-1)))
    return w

def find_nearest(array, value):
    return (np.abs(np.asarray(array) - value)).argmin()

def rfft_full(signal, Fs, minf, maxf, fstep):
    freq, amp, freqx, ampx, freq2h, amp2h, freq3h, amp3h = [], [], [], [], [], [], [], []
    F = int(Fs/fstep)
    win = ft_window(F)
    if len(signal.shape) == 1:
        signal = np.expand_dims(signal, axis=0)
    
    for x in range(0, signal.shape[1] - F, F):
        y0 = abs(np.fft.rfft(signal[0, x:x + F] * win))
        f0 = np.argmax(y0)
        if f0 >= minf/fstep and f0 <= maxf/fstep:
            freq.append(f0*fstep)
            amp.append(y0[f0])
            if 2*f0 < F/2-2:
                f2 = np.argmax(y0[(2*f0)-2:(2*f0)+2])
                freq2h.append(f0*fstep)
                amp2h.append(y0[2*f0-2+f2])
            if 3*f0 < F/2-2:
                f3 = np.argmax(y0[(3*f0)-2:(3*f0)+2])
                freq3h.append(f0*fstep)
                amp3h.append(y0[3*f0-2+f3])
        if signal.shape[0] > 1:
            y1 = abs(np.fft.rfft(signal[1, x:x + F] * win))
            f1 = np.argmax(y1)
            if f0 >= minf/fstep and f0 <= maxf/fstep:
                freqx.append(f1*fstep)
                ampx.append(y1[f1])
    return freq, amp, freqx, ampx, freq2h, amp2h, freq3h, amp3h

def interpolate(f, a, minf, maxf, fstep):
    f, a = np.array(f), np.array(a)
    bins = np.arange(minf, maxf + fstep, fstep)
    indices = np.digitize(f, bins) - 1
    f_out, a_out = [], []
    for i, bin_center in enumerate(bins):
        mask = (indices == i)
        if np.any(mask):
            f_out.append(bin_center)
            a_out.append(20 * np.log10(np.mean(a[mask])))
    return f_out, a_out

def createplotdata(signal, Fs, config, norm=[0]):
    import time
    start_time = time.time()
    
    def process_chunk(signal, Fs, fmin, fmax, step, offset):
        chunk_start = time.time()
        f, a, fx, ax, f2, a2, f3, a3 = rfft_full(signal, Fs, fmin, fmax, step)
        console.log(f"    rfft_full({fmin}-{fmax}Hz) took: {time.time() - chunk_start:.3f}s")
        
        interp_start = time.time()
        f, a = interpolate(f, a, fmin, fmax, step)
        fx, ax = interpolate(fx, ax, fmin, fmax, step)
        f2, a2 = interpolate(f2, a2, fmin, fmax, step)
        f3, a3 = interpolate(f3, a3, fmin, fmax, step)
        console.log(f"    interpolation took: {time.time() - interp_start:.3f}s")
        
        offset_start = time.time()
        a = [amp - offset for amp in a]
        ax = [amp - offset for amp in ax] if ax else []
        a2 = [amp - offset for amp in a2]
        a3 = [amp - offset for amp in a3]
        console.log(f"    offset calculation took: {time.time() - offset_start:.3f}s")
        return f, a, fx, ax, f2, a2, f3, a3
    
    fout, aout, foutx, aoutx, fout2, aout2, fout3, aout3 = [], [], [], [], [], [], [], []
    
    console.log("  Processing frequency chunks...")
    for fmin, fmax, step, offset in [(20,45,5,26.03), (50,90,10,19.995), (100,980,20,13.99), (1000,20000,100,0)]:
        console.log(f"  Processing chunk {fmin}-{fmax}Hz...")
        f, a, fx, ax, f2, a2, f3, a3 = process_chunk(signal, Fs, fmin, fmax, step, offset)
        fout.extend(f); aout.extend(a); foutx.extend(fx); aoutx.extend(ax)
        fout2.extend(f2); aout2.extend(a2); fout3.extend(f3); aout3.extend(a3)
    
    if norm[0] == 0:
        i = find_nearest(fout, config['normalize'])
        norm[0] = aout[i]
    
    aout = [a - norm[0] for a in aout]
    aoutx = [a - norm[0] for a in aoutx] if aoutx else []
    aout2 = [a - norm[0] for a in aout2]
    aout3 = [a - norm[0] for a in aout3]
    
    filter_start = time.time()
    sos = iirfilter(3, 0.5, btype='lowpass', output='sos')
    aout = sosfiltfilt(sos, aout)
    aout2 = sosfiltfilt(sos, aout2)
    aout3 = sosfiltfilt(sos, aout3)
    if len(aoutx) > 0:
        aoutx = sosfiltfilt(sos, aoutx)
    console.log(f"  filtering took: {time.time() - filter_start:.3f}s")
    
    console.log(f"  createplotdata TOTAL: {time.time() - start_time:.2f}s")
    return fout, aout, foutx, aoutx, fout2, aout2, fout3, aout3

def riaaiir(sig, Fs, mode, inv):
    if Fs == 96000:
        at = [1, -0.66168391, -0.18158841]
        bt = [0.1254979638905360, 0.0458786797031512, 0.0018820452752401]
        ars = [1, -0.60450091, -0.39094593]
        brs = [0.90861261463964900, -0.52293147388301200, -0.34491369168550900]
    if inv == 1:
        at, bt = bt, at
        ars, brs = brs, ars
    if mode == 1:
        sig = lfilter(brs, ars, sig)
    elif mode == 2:
        sig = lfilter(bt, at, sig)
    elif mode == 3:
        sig = lfilter(bt, at, sig)
        sig = lfilter(brs, ars, sig)
    return sig

def process_audio():
    try:
        import time
        start_time = time.time()
        
        # Update UI immediately
        document.getElementById('status').textContent = 'üîÑ Starting analysis...'
        document.getElementById('status').className = 'processing'
        
        console.log("Processing...")
        
        # Get data from JavaScript - optimize data conversion
        import js
        document.getElementById('status').textContent = 'üîÑ Converting file data...'
        console.log("Converting file data...")
        data_start = time.time()
        
        # More efficient data conversion with memory management
        file0_array = js.js_file0_data.to_py()
        file0_data = bytes(file0_array)
        del file0_array  # Free memory immediately
        
        file1_data = None
        if js.js_file1_data:
            file1_array = js.js_file1_data.to_py()
            file1_data = bytes(file1_array)
            del file1_array  # Free memory immediately
        
        config = js.js_config.to_py()
        console.log(f"Data conversion took: {time.time() - data_start:.2f}s")
        
        document.getElementById('status').textContent = 'üîÑ Reading audio files...'
        wav_start = time.time()
        console.log("Data conversion complete, reading WAV...")
        
        with io.BytesIO(file0_data) as wav_io:
            Fs, audio0 = wavfile.read(wav_io)
        
        console.log(f"WAV reading took: {time.time() - wav_start:.2f}s")
        console.log(f"Loaded audio: {Fs}Hz, {len(audio0)} samples")
        
        convert_start = time.time()
        if audio0.dtype == np.int16:
            audio0 = audio0.astype(np.float32) / 32768.0
        elif audio0.dtype == np.int32:
            audio0 = audio0.astype(np.float32) / 2147483648.0
        audio0 = audio0.T
        console.log(f"Audio conversion took: {time.time() - convert_start:.2f}s")
        
        if config['riaa_mode'] != 0:
            document.getElementById('status').textContent = 'üîÑ Applying RIAA filter...'
            riaa_start = time.time()
            console.log("Applying RIAA filter...")
            audio0 = riaaiir(audio0, Fs, config['riaa_mode'], config['riaa_inverse'])
            console.log(f"RIAA filtering took: {time.time() - riaa_start:.2f}s")
        
        document.getElementById('status').textContent = 'üîÑ Analyzing frequency response...'
        plot_data_start = time.time()
        console.log("Creating plot data...")
        fo0, ao0, fox0, aox0, fo2h0, ao2h0, fo3h0, ao3h0 = createplotdata(audio0, Fs, config)
        console.log(f"Plot data creation took: {time.time() - plot_data_start:.2f}s")
        
        # Clear audio0 from memory if no longer needed
        del audio0
        
        has_file1 = file1_data is not None
        if has_file1:
            document.getElementById('status').textContent = 'üîÑ Processing second file...'
            file1_start = time.time()
            console.log("Processing second file...")
            with io.BytesIO(file1_data) as wav_io:
                Fs1, audio1 = wavfile.read(wav_io)
            console.log(f"Second WAV reading took: {time.time() - file1_start:.2f}s")
            
            convert1_start = time.time()
            if audio1.dtype == np.int16:
                audio1 = audio1.astype(np.float32) / 32768.0
            elif audio1.dtype == np.int32:
                audio1 = audio1.astype(np.float32) / 2147483648.0
            audio1 = audio1.T
            console.log(f"Second audio conversion took: {time.time() - convert1_start:.2f}s")
            
            if config['riaa_mode'] != 0:
                document.getElementById('status').textContent = 'üîÑ Applying RIAA to second file...'
                riaa1_start = time.time()
                audio1 = riaaiir(audio1, Fs1, config['riaa_mode'], config['riaa_inverse'])
                console.log(f"Second RIAA filtering took: {time.time() - riaa1_start:.2f}s")
            
            norm_val = [ao0[find_nearest(fo0, config['normalize'])]]
            plot_data1_start = time.time()
            fo1, ao1, fox1, aox1, fo2h1, ao2h1, fo3h1, ao3h1 = createplotdata(audio1, Fs1, config, norm_val)
            console.log(f"Second plot data creation took: {time.time() - plot_data1_start:.2f}s")
            del audio1
        
        document.getElementById('status').textContent = 'üîÑ Generating plot...'
        plot_start = time.time()
        console.log("Generating plot...")
        
        plt.rcParams["xtick.minor.visible"] = True
        plt.rcParams["ytick.minor.visible"] = True
        
        if config['plot_style'] == 4:
            fig, axs = plt.subplots(2, 1, sharex=True, figsize=(14, 10))
            axs[0].semilogx(fo0, ao0, color='#0000ff', linewidth=2)
            if has_file1:
                axs[0].semilogx(fo1, ao1, color='#ff0000', linewidth=2)
            axs[0].set_ylim(-5, 5)
            axs[0].set_ylabel("Amplitude (dB)")
            axs[0].grid(True, which="major", ls="-", color="black", alpha=0.3)
            axs[0].grid(True, which="minor", ls="-", color="gainsboro", alpha=0.2)
            
            axs[1].semilogx(fo0, ao0, color='#0000ff', linewidth=2)
            axs[1].semilogx(fo2h0, ao2h0, color='#0080ff', linewidth=1, alpha=0.8)
            axs[1].semilogx(fo3h0, ao3h0, color='#00dfff', linewidth=1, alpha=0.8)
            if len(aox0) > 0:
                axs[1].semilogx(fox0, aox0, color='#0000ff', linestyle='--', linewidth=1.5)
            if has_file1:
                axs[1].semilogx(fo1, ao1, color='#ff0000', linewidth=2)
                axs[1].semilogx(fo2h1, ao2h1, color='#ff8000', linewidth=1, alpha=0.8)
                axs[1].semilogx(fo3h1, ao3h1, color='#ffdf00', linewidth=1, alpha=0.8)
                if len(aox1) > 0:
                    axs[1].semilogx(fox1, aox1, color='#ff0000', linestyle='--', linewidth=1.5)
            axs[1].set_ylabel("Amplitude (dB)")
            axs[1].set_xlabel("Frequency (Hz)")
            axs[1].grid(True, which="major", ls="-", color="black", alpha=0.3)
            axs[1].grid(True, which="minor", ls="-", color="gainsboro", alpha=0.2)
            
            for ax in axs:
                ax.set_xticks([20, 50, 100, 500, 1000, 5000, 10000, 20000])
                ax.set_xticklabels(['20', '50', '100', '500', '1k', '5k', '10k', '20k'])
                anchored_text = AnchoredText('SJ', frameon=False, borderpad=0, pad=0.03,
                                            loc=1, bbox_transform=ax.transAxes,
                                            prop={'color':'m', 'fontsize':25, 'alpha':0.4, 'style':'oblique'})
                ax.add_artist(anchored_text)
            gs = GridSpec(2, 1, height_ratios=[1, 2])
            axs[0].set_position(gs[0].get_position(fig))
            axs[1].set_position(gs[1].get_position(fig))
            
        else:
            fig, ax = plt.subplots(1, 1, figsize=(14, 6))
            ax.semilogx(fo0, ao0, color='#0000ff', linewidth=2)
            if has_file1:
                ax.semilogx(fo1, ao1, color='#ff0000', linewidth=2)
            ax.set_ylabel("Amplitude (dB)")
            ax.set_xlabel("Frequency (Hz)")
            ax.set_ylim(-5, 5)
            ax.grid(True, which="major", ls="-", color="black", alpha=0.3)
            ax.grid(True, which="minor", ls="-", color="gainsboro", alpha=0.2)
            ax.set_xticks([20, 50, 100, 500, 1000, 5000, 10000, 20000])
            ax.set_xticklabels(['20', '50', '100', '500', '1k', '5k', '10k', '20k'])
        
        plt.suptitle("SJPlot Online - Full Analysis", fontsize=16)
        plt.tight_layout()
        
        console.log("Saving plot...")
        buf = io.BytesIO()
        plt.savefig(buf, format='png', dpi=192, bbox_inches='tight')
        buf.seek(0)
        img_data = base64.b64encode(buf.read()).decode()
        # Don't call plt.close() - it causes issues in PyScript
        plt.clf()  # Clear the current figure instead
        console.log(f"Plot generation took: {time.time() - plot_start:.2f}s")
        
        results_start = time.time()
        console.log("Calculating results...")
        deltaadj = ao0[find_nearest(fo0, config['normalize'])]
        deltah0 = round(max(ao0 - deltaadj), 1)
        deltal0 = abs(round(min(ao0 - deltaadj), 1))
        
        html = f'''<div style="background:white; padding:20px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.1);">
            <h3>‚úÖ Complete</h3>
            <img src="data:image/png;base64,{img_data}" style="width:100%;" />
            <div style="margin-top:20px; padding:20px; background:#f8f9ff; border-radius:10px;">
                <p><strong>Range:</strong> +{deltah0}dB, ‚àí{deltal0}dB | <strong>SR:</strong> {Fs}Hz</p>
                <p><strong>Features:</strong> FFT ‚úì RIAA ‚úì Harmonics ‚úì Crosstalk ‚úì</p>
            </div></div>'''
        
        document.getElementById('output').innerHTML = html
        document.getElementById('status').textContent = '‚úÖ Complete!'
        document.getElementById('status').className = 'success'
        document.getElementById('loading').classList.remove('active')
        # Re-enable button by calling JS function
        from js import updateAnalyzeButtonState
        updateAnalyzeButtonState()
        console.log(f"Results calculation took: {time.time() - results_start:.2f}s")
        console.log(f"TOTAL PROCESSING TIME: {time.time() - start_time:.2f}s")
        console.log("Done!")
        
    except Exception as e:
        import traceback
        err = traceback.format_exc()
        console.error(err)
        document.getElementById('output').innerHTML = f'<div style="color:red; padding:20px;"><strong>Error:</strong> {str(e)}</div>'
        document.getElementById('status').textContent = f'‚ùå Error'
        document.getElementById('status').className = 'error'
        document.getElementById('loading').classList.remove('active')
        # Re-enable button by calling JS function
        from js import updateAnalyzeButtonState
        updateAnalyzeButtonState()

# Make the function available globally for JavaScript to call
import js
js.window.pyProcessAudio = process_audio

console.log("Python environment ready! PyScript functions available.")
    </py-script>

    <script>
        let file0Data = null, file1Data = null;
        let pyScriptReady = false;
        
        // Test network connectivity to PyScript CDN
        function testPyScriptCDN() {
            fetch('https://pyscript.net/releases/2024.8.2/core.js', { method: 'HEAD' })
                .then(response => {
                    if (response.ok) {
                        console.log('PyScript CDN is reachable');
                        document.getElementById('pyscriptStatus').textContent = 'PyScript loading, please wait...';
                    } else {
                        console.error('PyScript CDN returned error:', response.status);
                        document.getElementById('pyscriptStatus').innerHTML = `
                            PyScript CDN error: ${response.status}<br>
                            <a href="javascript:location.reload()">Try refreshing the page</a>
                        `;
                        document.getElementById('pyscriptStatus').style.color = 'red';
                    }
                })
                .catch(error => {
                    console.error('Cannot reach PyScript CDN:', error);
                    document.getElementById('pyscriptStatus').innerHTML = `
                        Cannot reach PyScript CDN. Check your internet connection.<br>
                        <a href="javascript:location.reload()">Try refreshing the page</a>
                    `;
                    document.getElementById('pyscriptStatus').style.color = 'red';
                });
        }
        
        // Test CDN connectivity first
        testPyScriptCDN();
        
        // Listen for PyScript events properly
        document.addEventListener('py:ready', function() {
            console.log('py:ready event fired - PyScript is ready!');
            pyScriptReady = true;
            updateAnalyzeButtonState();
            // Stop any ongoing polling
            pollCount = 999; 
        });
        
        document.addEventListener('py:all-done', function() {
            console.log('py:all-done event fired - PyScript is ready!');
            pyScriptReady = true;
            updateAnalyzeButtonState();
            // Stop any ongoing polling
            pollCount = 999;
        });
        
        // Also listen for other possible events
        document.addEventListener('pyscript:ready', function() {
            console.log('pyscript:ready event fired');
            pyScriptReady = true;
            updateAnalyzeButtonState();
        });
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, starting PyScript checks...');
        });
        
        // More aggressive polling approach with detailed logging
        let pollCount = 0;
        function pollForPyScript() {
            // If events already fired, stop polling
            if (pyScriptReady) {
                console.log('PyScript already ready, stopping poll');
                return;
            }
            
            pollCount++;
            console.log(`Poll ${pollCount}: Checking PyScript status...`);
            console.log('window.pyscript exists:', !!window.pyscript);
            
            // Check for newer PyScript API
            if (window.pyscript) {
                console.log('window.pyscript keys:', Object.keys(window.pyscript));
                // In newer versions, just having pyscript object means it's ready
                console.log('PyScript object found - assuming ready!');
                pyScriptReady = true;
                updateAnalyzeButtonState();
                return;
            }
            
            // Check for Pyodide directly
            if (window.pyodide && window.pyodide.runPython) {
                console.log('Pyodide runPython available - PyScript is ready!');
                pyScriptReady = true;
                updateAnalyzeButtonState();
                return;
            }
            
            if (pollCount < 15) { // Reduced to 15 seconds since events should fire
                setTimeout(pollForPyScript, 1000);
            } else {
                console.error('PyScript polling timed out, but events may have fired');
                if (!pyScriptReady) {
                    document.getElementById('pyscriptStatus').innerHTML = `
                        PyScript polling timed out, but it may still be working.<br>
                        <a href="javascript:forcePyScriptReady()">Force Ready (recommended)</a> or 
                        <a href="javascript:location.reload()">Refresh page</a>
                    `;
                    document.getElementById('pyscriptStatus').style.color = 'orange';
                }
            }
        }
        
        // Also try the window load event as a fallback
        window.addEventListener('load', function() {
            console.log('Window loaded, starting PyScript polling in 3 seconds...');
            setTimeout(pollForPyScript, 3000); // Start polling after 3 seconds
        });
        
        // Add a manual override for testing
        window.forcePyScriptReady = function() {
            console.log('Forcing PyScript ready state...');
            pyScriptReady = true;
            updateAnalyzeButtonState();
            document.getElementById('pyscriptStatus').style.display = 'none';
            console.log('PyScript manually marked as ready');
        };
        
        // Also add a debug function
        window.debugPyScript = function() {
            console.log('=== PyScript Debug Info ===');
            console.log('pyScriptReady:', pyScriptReady);
            console.log('window.pyscript:', window.pyscript);
            console.log('window.pyodide:', window.pyodide);
            if (window.pyscript) {
                console.log('pyscript keys:', Object.keys(window.pyscript));
            }
            console.log('========================');
        };
        
        function updateAnalyzeButtonState() {
            const btn = document.getElementById('analyzeBtn');
            const statusDiv = document.getElementById('pyscriptStatus');
            
            if (file0Data && pyScriptReady) {
                btn.disabled = false;
                btn.textContent = 'üî¨ Analyze Audio';
                statusDiv.style.display = 'none';
            } else if (!pyScriptReady) {
                btn.disabled = true;
                btn.textContent = '‚è≥ Loading PyScript...';
                statusDiv.style.display = 'block';
                statusDiv.style.color = '#666';
            } else {
                btn.disabled = true;
                btn.textContent = 'üî¨ Analyze Audio';
                statusDiv.textContent = 'Upload a WAV file to begin';
                statusDiv.style.display = 'block';
                statusDiv.style.color = '#666';
            }
        }
        
        // Make function globally available for Python to call
        window.updateAnalyzeButtonState = updateAnalyzeButtonState;
        
        document.getElementById('fileInput0').addEventListener('change', e => handleFile(e.target.files[0], 0));
        document.getElementById('fileInput1').addEventListener('change', e => handleFile(e.target.files[0], 1));
        
        function handleFile(file, index) {
            if (!file || !file.name.toLowerCase().endsWith('.wav')) {
                alert('Please select a WAV file');
                return;
            }
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                if (index === 0) file0Data = {name: file.name, bytes: data};
                else file1Data = {name: file.name, bytes: data};
                
                let html = '<strong>Ready:</strong><br>';
                if (file0Data) html += `üìÑ ${file0Data.name}<br>`;
                if (file1Data) html += `üìÑ ${file1Data.name}`;
                document.getElementById('fileInfo').innerHTML = html;
                document.getElementById('fileInfo').style.display = 'block';
                updateAnalyzeButtonState();
            };
            reader.readAsArrayBuffer(file);
        }
        
        function startAnalysis() {
            if (!file0Data) { alert('Upload a file first'); return; }
            
            // Check if PyScript is ready
            if (!pyScriptReady) {
                alert('PyScript is still loading. Please wait a moment and try again.');
                return;
            }
            
            // Check if Python function is available
            if (!window.pyProcessAudio) {
                alert('Python environment not ready. Please wait a moment and try again.');
                return;
            }
            
            document.getElementById('status').textContent = 'Processing...';
            document.getElementById('status').className = 'info';
            document.getElementById('loading').classList.add('active');
            document.getElementById('analyzeBtn').disabled = true;
            
            const config = {
                plot_style: parseInt(document.getElementById('plotStyle').value),
                riaa_mode: parseInt(document.getElementById('riaaMode').value),
                riaa_inverse: document.getElementById('riaaInverse').checked ? 1 : 0,
                normalize: parseInt(document.getElementById('normalize').value)
            };
            
            try {
                console.log('Calling Python function directly...');
                
                // Set global JS variables that Python can access
                window.js_file0_data = file0Data.bytes;
                window.js_file1_data = file1Data ? file1Data.bytes : null;
                window.js_config = config;
                
                // Call the Python function directly - no PyScript reinitialization!
                window.pyProcessAudio();
                
            } catch (error) {
                console.error('Analysis error:', error);
                document.getElementById('status').textContent = '‚ùå Error: ' + error.message;
                document.getElementById('status').className = 'error';
                document.getElementById('loading').classList.remove('active');
                updateAnalyzeButtonState();
            }
        }
    </script>
</body>
</html>
